server {
        listen 80;
        server_name zbx.cloud-dd.com;
        rewrite ^(.*)$ https://$server_name$1 permanent;
}


server {

    listen              80;
    server_name         zbx.cloud-dd.com;
    root                /data/www/zabbix;
    access_log          /data/log/nginx/zabbix.log main;
    error_log           /data/log/nginx/error_zabbix.log;


    set $skip_cache 0;

    # POST requests and urls with a query string should always go to PHP

    if ($request_method = POST) {
        set $skip_cache 1;
    }

    if ($query_string != "") {
       set $skip_cache 1;
    }

    # Don't cache uris containing the following segments

    if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
        #set $skip_cache 1;
    }

    # Don't use the cache for logged in users or recent commenters

    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        #set $skip_cache 1;
    }


fastcgi_cache_path          /var/run/nginx-cache levels=1:2 keys_zone=FPMCache:100m inactive=60m;
fastcgi_cache_key           "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale     error timeout invalid_header http_500;
fastcgi_ignore_headers      Cache-Control Expires Set-Cookie;
fastcgi_temp_path           /tmp/fpm;


    location / {
        index index.php index.html;

    }


    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

fastcgi_cache                   FPMCache;
fastcgi_cache_valid             200 302 1h;
fastcgi_cache_valid             301 1d;
fastcgi_cache_valid             any 1m;
fastcgi_cache_min_uses          1;
fastcgi_cache_bypass            $skip_cache;
fastcgi_no_cache                $skip_cache;
fastcgi_split_path_info         ^(.+\.php)(/.+)$;

    }
    
}

